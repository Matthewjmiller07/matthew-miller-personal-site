---
import Layout from '../layouts/Layout.astro';
---

<Layout
    title="When Are the Jewish Holidays?"
    description="Discover upcoming Jewish holidays, important dates, and other key information."
>
    <!-- External Stylesheets and Scripts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sizzle/2.3.6/sizzle.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel@7.6.4/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9554355274659744" crossorigin="anonymous"></script>

    <main>
        <header>
            <h1>When Are the Jewish Holidays?</h1>
        </header>

        <div class="floating-box" id="filterBox">
            <button id="toggleFiltersButton">Filters</button>
            <div id="filterContent">  
                <label for="includeTishaBav" class="checkbox-tishabav">
                    <input type="checkbox" id="includeTishaBav">
                    Tish'a B'Av
                </label>
                <label for="includeCholHaMoed" class="checkbox-cholhamoed">
                    <input type="checkbox" id="includeCholHaMoed">
                    Chol HaMoed
                </label>
                <label for="includeMinorFastDays" class="checkbox-minorfastdays">
                    <input type="checkbox" id="includeMinorFastDays">
                    Minor Fast Days
                </label>
                <label for="includePurim" class="checkbox-purim">
                    <input type="checkbox" id="includePurim">
                    Purim
                </label>
            </div>
        </div>

        <div class="api-section">
            <h2>Calculate Work Days Off for Jewish Holidays</h2>
            <label for="yearSelect">Select Year:</label>
            <select id="yearSelect"></select>
            <button onclick="calculateDaysOff()">Calculate Days Off</button>
            <div id="results"></div>
            <canvas id="workdaysChart"></canvas>
        </div>

        <div class="api-section">
            <h2>Calendar of Weekday Holidays</h2>
            <button id="toggleCalendar">Hide Calendar</button>
            <div id="holidayCalendar"></div>
        </div>

        <div class="api-section" id="holidayInfoSection">
            <h2>About the Holidays</h2>
            <div id="holidayDetails"></div>
        </div>

        <div class="api-section">
            <h2>Comparison of Weekday Holidays</h2>
            <label for="startYearInput">Start Year:</label>
            <input type="number" id="startYearInput" value="2020" min="1900" max="2100">
            <label for="endYearInput">End Year:</label>
            <input type="number" id="endYearInput" value="2025" min="1900" max="2100">
            <button onclick="updateComparison()">Update Comparison</button>
            <canvas id="comparisonChart"></canvas>
        </div>

        <div class="api-section">
            <h2>Jewish Holiday Timeline</h2>
            <p>This section dynamically fetches and displays Jewish holidays, highlighting past and upcoming dates.</p>
            <button id="fetchHolidays">Fetch Holidays</button>
            <div id="holidayList"></div>
        </div>

        <div class="api-section">
            <h2>Visualize Holiday Countdown</h2>
            <p>This section visualizes the countdown to upcoming holidays with a bar chart.</p>
            <canvas id="holidayChart"></canvas>
        </div>

        <!-- React Component for Additional Jewish Themed Content -->
        <div id="reactApp"></div>
    </main>

    <style>
        /* Specific Holiday Colors */
        .checkbox-tishabav, .calendar-day.holiday.tisha-bav, .tisha-bav {
            background-color: rgba(255, 99, 132, 0.2); 
            border: 1px solid rgba(255, 99, 132, 1);
        }
        .checkbox-cholhamoed, .calendar-day.holiday.chol-hamoed, .chol-hamoed {
            background-color: rgba(54, 162, 235, 0.2);
            border: 1px solid rgba(54, 162, 235, 1);
        }
        .checkbox-minorfastdays, .calendar-day.holiday.minor-fast-days, .minor-fast-days {
            background-color: rgba(255, 206, 86, 0.2); 
            border: 1px solid rgba(255, 206, 86, 1);
        }
        .checkbox-purim, .calendar-day.holiday.purim, .purim {
            background-color: rgba(75, 192, 192, 0.2);
            border: 1px solid rgba(75, 192, 192, 1);
        }
        
        /* General Styles */
        body {
            font-family: 'Noto Sans Hebrew', sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }
        
        header {
            background-color: white;
            border-bottom: 2px solid #ddd;
            text-align: center;
            position: sticky;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        header h1 {
            margin: 0;
            padding: 20px 0; 
        }
        
        /* Filter Section */
        .floating-box {
            background-color: white;
            border-bottom: 2px solid #ddd;
            position: sticky;
            width: 100%;
            top: 80px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            padding: 10px; 
        }
        
        .floating-box label {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            gap: 5px;
        }
        
        .floating-box input[type="checkbox"] {
            margin-right: 10px;
            vertical-align: middle;
            margin: 0 5px 0 0;
        }
        
        /* Main Content Area */
        main {
            margin-top: 160px;
            padding: 20px;
        }
        
        /* Sections */
        .api-section {
            background-color: white;
            border: 2px solid #ddd;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Form Elements */
        button, select, input[type="checkbox"] {
            background-color: #4CAF50; 
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        button:hover {
            background-color: #45a049; 
        }
        
        p {
            font-size: 14px;
            color: #555;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f8f8;
        }
        
        .past-holiday {
            color: #888;
        }
        
        .upcoming-holiday {
            color: #4CAF50;
        }
        
        /* Charts */
        #workdaysChart {
            max-width: 300px;
            max-height: 300px;
            width: 100%;
            height: auto;
        }
        
        /* Holiday Calendar */
        #holidayCalendar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 10px;
            margin-top: 20px;
        }
        
        .calendar-month {
            flex: 1 1 45%;
            max-width: 45%;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 500px; 
            margin-bottom: 20px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day, .calendar-day-header {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            font-size: 1em;
        }
        
        .calendar-day.empty {
            background-color: #f4f4f4;
        }
        
        .calendar-day-header {
            background-color: #f4f4f4;
            font-weight: bold;
        }
        
        .calendar-month h3 {
            text-align: center;
            font-size: 1.2em;
            margin: 5px 0;
        }
        
        .calendar-day.holiday { 
            background-color: #f4f4f4; 
            color: #888; 
        }
        
        #toggleFiltersButton {
            display: block;
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        #filterBox {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 10px; 
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            max-width: 150px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        #filterBox.open {
            top: 50px;
        }
        
        #filterBox h2 {
            margin-top: 0;
        }
        
        #filterBox label {
            display: block;
            margin-bottom: 10px;
        }
        
        #filterBox input[type="checkbox"] {
            margin-right: 5px;
        }
        
        #filterContent {
            display: none;
        }
        
        #filterBox.open #filterContent {
            display: block;
        }
        
        #closeFilterBox {
            cursor: pointer;
            float: right;
        }
        
        #holidayDetails {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .holiday-info-card {
            background-color: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1 1 300px;
        }
        
        /* Media Queries */
        @media (max-width: 1024px) {
            .calendar-month {
                flex: 1 1 100%;
                max-width: 100%;
                min-height: 450px;
            }
        }
        
        @media (max-width: 768px) {
            .floating-box {
                position: static; 
                width: auto;      
                margin: 0 -20px;   
                padding: 10px 20px; 
            }
            
            .floating-box label {
                font-size: 14px;
                padding: 5px;   
            }
            
            .calendar-day, .calendar-day-header {
                padding: 5px;
                font-size: 0.8em;
            }
            
            .calendar-days {
                display: grid;
                grid-template-columns: repeat(7, minmax(30px, 1fr));
                gap: 2px;
            }
            
            .calendar-month {
                overflow: auto;
                padding: 10px;
                min-height: 400px;
            }
            
            .calendar-day {
                box-sizing: border-box;
            }
        }
        
        @media (max-width: 480px) { 
            .calendar-day, .calendar-day-header {
                padding: 5px; 
                font-size: 0.7em;
            }
            
            .calendar-month {
                padding: 10px;
                min-height: 350px; 
            }
            
            #holidayCalendar {
                flex-direction: column; 
                align-items: center;
            }
            
            .calendar-month {
                width: 100%;
                max-width: 100%;
                min-height: auto; 
            }
        }
    </style>

    <!-- React Component Script -->
    <script type="text/babel">
        class ReactApp extends React.Component {
            render() {
                return (
                    <div className="api-section">
                        <h2>React Managed Jewish Events</h2>
                        <p>This section is managed by React and demonstrates more dynamic interactions with a Jewish theme.</p>
                        <div>Content generated by React...</div>
                    </div>
                );
            }
        }

        ReactDOM.render(<ReactApp />, document.getElementById('reactApp'));
    </script>

    <!-- Main JavaScript functionality -->
    <script>
        // Global variables
        var workdaysChart = null;
        var comparisonChart = null;

        $(document).ready(function() {
            console.log("Document ready");
            
            const currentYear = new Date().getFullYear();

            // Populate year selection dropdowns
            for (let year = currentYear - 100; year <= currentYear + 100; year++) {
                $('#yearSelect').append(new Option(year, year));
            }
            $('#yearSelect').val(currentYear);

            // Initial calculations
            calculateDaysOff();
            updateComparison();

            // Re-calculate when changes are made
            $('#yearSelect, #includeTishaBav, #includeCholHaMoed, #includeMinorFastDays, #includePurim').change(calculateDaysOff);

            // Initialize Draggable Functionality
            $("#filterBox").draggable();

            // Toggle Filters Button Click Event
            $('#toggleFiltersButton').click(function() {
                $('#filterContent').toggle();
                $(this).text($('#filterContent').is(':visible') ? 'Close' : 'Filters');
            });

            // Toggle calendar visibility
            $('#toggleCalendar').click(function() {
                $('#holidayCalendar').toggle();
                const isVisible = $('#holidayCalendar').is(':visible');
                $(this).text(isVisible ? 'Hide Calendar' : 'Show Calendar');
            });

            // Fetch holidays button
            $('#fetchHolidays').click(function() {
                fetchHolidaysData();
            });
        });

        function fetchHolidayData(year, includeTishaBav, includeCholHaMoed, includeMinorFastDays, includePurim, callback) {
            console.log("Fetching holiday data for year:", year);
            
            const holidays = [
                'Pesach I', 'Pesach II', 'Pesach VII', 'Pesach VIII',
                'Shavuot I', 'Shavuot II',
                'Sukkot I', 'Sukkot II',
                'Shmini Atzeret', 'Simchat Torah',
                'Yom Kippur'
            ];

            const yearSpecificHolidays = ['Rosh Hashana II'];

            if (includeTishaBav) {
                yearSpecificHolidays.push("Tish'a B'Av");
            }
            if (includePurim) {
                yearSpecificHolidays.push("Purim");
            }
            if (includeCholHaMoed) {
                yearSpecificHolidays.push(
                    "Pesach III (CH''M)", "Pesach IV (CH''M)", "Pesach V (CH''M)", "Pesach VI (CH''M)",
                    "Sukkot III (CH''M)", "Sukkot IV (CH''M)", "Sukkot V (CH''M)", "Sukkot VI (CH''M)", "Sukkot VII (Hoshana Raba)"
                );
            }
            if (includeMinorFastDays) {
                yearSpecificHolidays.push("Asara B'Tevet", "Tzom Gedaliah", "Ta'anit Esther");
            }

            const apiUrl = `https://www.hebcal.com/hebcal?v=1&cfg=json&year=${year}&maj=on&min=on&mod=on&nx=on&mf=on&s=on`;
            
            $.getJSON(apiUrl, function(data) {
                let totalDaysOff = 0;
                let totalHolidays = 0;
                let details = '';
                let allHolidays = [];

                data.items.forEach(item => {
                    const includeCholHaMoedCondition = includeCholHaMoed && (
                        item.title.includes("Pesach III") || 
                        item.title.includes("Pesach IV") || 
                        item.title.includes("Pesach V") || 
                        item.title.includes("Pesach VI") || 
                        item.title.includes("Sukkot III") || 
                        item.title.includes("Sukkot IV") || 
                        item.title.includes("Sukkot V") || 
                        item.title.includes("Sukkot VI") || 
                        item.title.includes("Sukkot VII")
                    );

                    if (holidays.includes(item.title) || yearSpecificHolidays.includes(item.title) || 
                        (item.title.startsWith('Rosh Hashana ') && /\d+$/.test(item.title)) || includeCholHaMoedCondition) {
                        
                        totalHolidays++;
                        const date = new Date(item.date + "T00:00:00Z");
                        const dayOfWeek = date.getUTCDay();
                        const weekdayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                        const dayName = weekdayNames[dayOfWeek];

                        let holidayClass = '';
                        if (item.title === "Tish'a B'Av" && includeTishaBav) {
                            holidayClass = 'tisha-bav';
                        } else if (item.title === "Purim" && includePurim) {
                            holidayClass = 'purim';
                        } else if (["Asara B'Tevet", "Tzom Gedaliah", "Ta'anit Esther"].includes(item.title) && includeMinorFastDays) {
                            holidayClass = 'minor-fast-days';
                        } else if ([
                            "Pesach III (CH''M)", "Pesach IV (CH''M)", "Pesach V (CH''M)", "Pesach VI (CH''M)",
                            "Sukkot III (CH''M)", "Sukkot IV (CH''M)", "Sukkot V (CH''M)", "Sukkot VI (CH''M)", "Sukkot VII (Hoshana Raba)"
                        ].includes(item.title) && includeCholHaMoed) {
                            holidayClass = 'chol-hamoed';
                        }

                        allHolidays.push({
                            title: item.title,
                            date: date,
                            dayName: dayName,
                            class: holidayClass
                        });

                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            totalDaysOff++;
                            details += `<li class="${holidayClass}">${item.title} falls on ${dayName}, ${date.toISOString().split('T')[0]} (which is a weekday). 
                                <a href="#" onclick="addToGoogleCalendar('${item.title}', '${date.toISOString()}')">Add to Google Calendar</a></li>`;
                        }
                    }
                });

                callback(totalDaysOff, totalHolidays, details, allHolidays);
            }).fail(function() {
                console.error('Failed to fetch holiday data for ' + year);
                callback(0, 0, '', []);
            });
        }

        function calculateDaysOff() {
            const currentYear = new Date().getFullYear();
            const selectedYear = $('#yearSelect').val();
            const includeTishaBav = $('#includeTishaBav').is(':checked');
            const includeCholHaMoed = $('#includeCholHaMoed').is(':checked');
            const includeMinorFastDays = $('#includeMinorFastDays').is(':checked');
            const includePurim = $('#includePurim').is(':checked');

            fetchHolidayData(selectedYear, includeTishaBav, includeCholHaMoed, includeMinorFastDays, includePurim, function(totalDaysOff, totalHolidays, holidayDetails, allHolidays) {
                const isPast = selectedYear < currentYear;
                const verbTense = isPast ? "needed" : "need";

                $('#results').html(`You ${verbTense} to take <strong>${totalDaysOff}</strong> workday holidays off work in ${selectedYear}.<ul>${holidayDetails}</ul>`);

                if (workdaysChart) workdaysChart.destroy();
                var ctx = document.getElementById('workdaysChart').getContext('2d');
                workdaysChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Workday Holidays', 'Weekend Holidays'],
                        datasets: [{
                            data: [totalDaysOff, totalHolidays - totalDaysOff],
                            backgroundColor: ['#4CAF50', '#DDDDDD'],
                            hoverBackgroundColor: ['#45a049', '#CCCCCC']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });

                displayHolidayCalendar(allHolidays);
            });
        }

        function updateComparison() {
            const startYear = parseInt($('#startYearInput').val());
            const endYear = parseInt($('#endYearInput').val());
            const includeTishaBav = $('#includeTishaBav').is(':checked');
            const includeCholHaMoed = $('#includeCholHaMoed').is(':checked');
            const includeMinorFastDays = $('#includeMinorFastDays').is(':checked');
            const includePurim = $('#includePurim').is(':checked');
            const years = [];
            const daysOff = [];

            for (let year = startYear; year <= endYear; year++) {
                years.push(year);
                fetchHolidayData(year, includeTishaBav, includeCholHaMoed, includeMinorFastDays, includePurim, function(totalDaysOff) {
                    daysOff.push(totalDaysOff);

                    if (years.length === daysOff.length) {
                        if (comparisonChart) comparisonChart.destroy();
                        var ctx = document.getElementById('comparisonChart').getContext('2d');
                        comparisonChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: years,
                                datasets: [{
                                    label: 'Workday Holidays',
                                    data: daysOff,
                                    fill: false,
                                    borderColor: '#4CAF50',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                },
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                    }
                                }
                            }
                        });
                    }
                });
            }
        }

        function displayHolidayCalendar(allHolidays) {
            console.log("Starting to display holiday calendar");

            const holidays = allHolidays;
            console.log("All parsed holidays:", holidays);

            const calendar = $('#holidayCalendar');
            calendar.empty();

            const currentYear = holidays.length > 0 ? holidays[0].date.getFullYear() : new Date().getFullYear();
            const monthNames = ["January", "February", "March", "April", "May", "June", 
                                "July", "August", "September", "October", "November", "December"];
            const weekdayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(currentYear, month, 1).getDay();
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();

                const monthDiv = $('<div class="calendar-month"></div>').append(`<h3>${monthNames[month]}</h3>`);
                const daysGrid = $('<div class="calendar-days"></div>');

                // Add day headers
                for (let i = 0; i < 7; i++) {
                    daysGrid.append(`<div class="calendar-day-header">${weekdayNames[i]}</div>`);
                }

                for (let i = 0; i < firstDay; i++) {
                    daysGrid.append('<div class="calendar-day empty"></div>');
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, month, day);
                    const holiday = holidays.find(holiday => holiday.date.toDateString() === date.toDateString());
                    const dayDiv = $('<div class="calendar-day"></div>').text(day);
                    if (holiday) {
                        console.log(`Found holiday on ${date.toDateString()}: ${holiday.title}`);
                        dayDiv.addClass('holiday').addClass(holiday.class).append(`<br>${holiday.title}`);
                    }
                    daysGrid.append(dayDiv);
                }

                monthDiv.append(daysGrid);
                calendar.append(monthDiv);
            }
        }

        function fetchHolidaysData() {
            console.log("Fetching holidays");
            const year = $('#yearSelect').val();
            $.ajax({
                url: `https://www.hebcal.com/hebcal?v=1&cfg=json&year=${year}&maj=on&min=on&mod=on&nx=on&mf=on&s=on`,
                type: 'GET',
                success: function(data) {
                    console.log("Data fetched", data);
                    const today = new Date();
                    const holidays = data.items.filter(item => item.category === 'holiday');
                    holidays.sort((a, b) => new Date(a.date) - new Date(b.date));
                    let listHtml = '<ul>';
                    let labels = [];
                    let daysUntilData = [];
                    let backgroundColors = [];
                    let borderColors = [];
                    let monthGroups = {};

                    const monthColors = {
                        'January': { background: 'rgba(255, 99, 132, 0.2)', border: 'rgba(255, 99, 132, 1)' },
                        'February': { background: 'rgba(54, 162, 235, 0.2)', border: 'rgba(54, 162, 235, 1)' },
                        'March': { background: 'rgba(255, 206, 86, 0.2)', border: 'rgba(255, 206, 86, 1)' },
                        'April': { background: 'rgba(75, 192, 192, 0.2)', border: 'rgba(75, 192, 192, 1)' },
                        'May': { background: 'rgba(153, 102, 255, 0.2)', border: 'rgba(153, 102, 255, 1)' },
                        'June': { background: 'rgba(255, 159, 64, 0.2)', border: 'rgba(255, 159, 64, 1)' },
                        'July': { background: 'rgba(199, 199, 199, 0.2)', border: 'rgba(199, 199, 199, 1)' },
                        'August': { background: 'rgba(83, 102, 255, 0.2)', border: 'rgba(83, 102, 255, 1)' },
                        'September': { background: 'rgba